## Start of configuration add by letsencrypt container
location ^~ /.well-known/acme-challenge/ {
    auth_basic off;
    auth_request off;
    allow all;
    root /usr/share/nginx/html;
    try_files $uri =404;
    break;
}
## End of configuration add by letsencrypt container

## Serve static files directly from nginx, fallback to CTFd for autogenerated files
location /themes/dojo_theme/static/ {
    alias /var/www/static/;
    
    # Try to serve the file directly, if not found, proxy to CTFd
    try_files $uri @ctfd_static;
    
    expires 1d;
    add_header Cache-Control "public, immutable";
    
    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    
    # Enable gzip compression for static files
    gzip on;
    gzip_types text/css application/javascript application/json image/svg+xml;
    gzip_vary on;
}

location @ctfd_static {
    # Proxy to CTFd for autogenerated files
    proxy_pass http://ctfd:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $proxy_x_forwarded_host;
    proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
    proxy_set_header X-Forwarded-Ssl $proxy_x_forwarded_ssl;
    proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port;
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $proxy_connection;
    proxy_buffering off;
}

location @forward {
    set $redirect_uri "$upstream_http_redirect_uri";
    set $redirect_auth "$upstream_http_redirect_auth";

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Forwarded-Prefix /sensai;
    proxy_set_header PWN-Trace_ID $request_id;


    proxy_set_header Authorization $redirect_auth;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_cache_bypass $http_upgrade;

    proxy_buffering off;
    proxy_http_version 1.1;
    proxy_pass $redirect_uri;

    proxy_ignore_headers X-Accel-Redirect;
}

