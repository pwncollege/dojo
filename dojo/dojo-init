#!/bin/sh

mount --make-shared /

data_mount_options="$(findmnt -nro OPTIONS -- /data)"
if [ "$?" -ne 0 ]; then
    echo "[+] Creating data storage"
    truncate -s 32G /data.img
    mkfs.ext4 /data.img
    loop_device=$(losetup -f)
    if [ ! -e "$loop_device" ]; then
        mknod $loop_device b 7 $(echo $loop_device | tr -cd '0-9')
        chmod --reference=/dev/loop0 $loop_device
        chown --reference=/dev/loop0 $loop_device
    fi
    losetup "$loop_device" /data.img
    mount --options X-mount.mkdir "$loop_device" /data
elif printf '%s' "$data_mount_options" | grep -Fqw 'nosuid'; then
    echo "[+] Remounting /data with suid enabled"
    mount --options remount,suid /data
fi
mount --make-shared /data

>> /data/config.env

> /data/.config.env
define () {
    name="$1"
    default="$2"
    re="^${name}=\K.*"
    current="$(env | grep -oP ${re})"
    defined="$(grep -oP ${re} /data/config.env)"
    value="${current:-${defined:-$default}}"
    echo "${name}=${value}" >> /data/.config.env
}
DEFAULT_DOJO_HOST=localhost.pwn.college

define DOJO_HOST "${DEFAULT_DOJO_HOST}"
define WORKSPACE_HOST workspace."${DEFAULT_DOJO_HOST}"
define DOJO_ENV development
define DOJO_WORKSPACE core
define WORKSPACE_KEY
define WORKSPACE_SECRET $(openssl rand -hex 16)
define WORKSPACE_NODE 0
define SECRET_KEY $(openssl rand -hex 16)
define INTERNET_FOR_ALL False
define MAIL_SERVER
define MAIL_PORT
define MAIL_USERNAME
define MAIL_PASSWORD
define MAIL_ADDRESS
define CORS_ORIGINS
define DOCKER_USERNAME
define DOCKER_TOKEN
define DISCORD_CLIENT_ID
define DISCORD_CLIENT_SECRET
define DISCORD_BOT_TOKEN
define DISCORD_GUILD_ID
define DB_HOST db
define DB_NAME ctfd
define DB_USER ctfd
define DB_PASS ctfd
define BACKUP_AES_KEY_FILE
define S3_BACKUP_BUCKET
define AWS_DEFAULT_REGION
define AWS_ACCESS_KEY_ID
define AWS_SECRET_ACCESS_KEY
define MAC_HOSTNAME
define MAC_USERNAME
define ENABLE_SPLUNK false

mv /data/.config.env /data/config.env
. /data/config.env

# Configure Docker daemon for Splunk logging if enabled
if [ "${ENABLE_SPLUNK}" = "true" ]; then
    echo "[+] Configuring Docker daemon for Splunk logging..."
    if [ "$WORKSPACE_NODE" -eq 0 ]; then
        echo "127.0.0.1 splunk" >> /etc/hosts
    else
        echo "192.168.42.1 splunk" >> /etc/hosts
    fi
    if [ -f /tmp/daemon-splunk.json ]; then
        cp /tmp/daemon-splunk.json /etc/docker/daemon.json
        echo "[+] Docker daemon configured for Splunk logging"
    else
        echo "[!] Warning: Splunk daemon configuration not found"
    fi
else
    # Ensure standard configuration is used
    if [ -f /tmp/daemon.json ]; then
        cp /tmp/daemon.json /etc/docker/daemon.json
    fi
fi

mkdir -p /data/workspace/nix
mkdir -p /data/workspacefs/bin
mkdir -p /data/ctfd-ipython
mkdir -p /data/coverage

# Enable systemd journal forwarding to Splunk if configured
if [ "${ENABLE_SPLUNK}" = "true" ]; then
    echo "[+] Enabling systemd journal forwarding to Splunk..."
    systemctl enable journal-to-splunk.service 2>/dev/null || true
fi

mkdir -p /data/homes
if [ "$(findmnt -nro FSTYPE -- /data/homes)" != "btrfs" ] && [ "$(findmnt -nro FSTYPE -- /data)" != "btrfs" ]; then
    if [ ! -f /data/homes/btrfs.img ]; then
        echo "[+] Creating home storage"
        truncate -s 256G /data/homes/btrfs.img
        mkfs.btrfs /data/homes/btrfs.img
    fi
    loop_device=$(losetup -f)
    if [ ! -e "$loop_device" ]; then
        mknod $loop_device b 7 $(echo $loop_device | tr -cd '0-9')
        chmod --reference=/dev/loop0 $loop_device
        chown --reference=/dev/loop0 $loop_device
    fi
    losetup "$loop_device" /data/homes/btrfs.img
    mount "$loop_device" /data/homes
fi
btrfs quota enable /data/homes

if [ ! -d /data/ssh_host_keys ]; then
    mkdir -p /data/ssh_host_keys
    rm /etc/ssh/ssh_host_*_key*
    ssh-keygen -A -m PEM
    for key in $(ls /etc/ssh/ssh_host_*_key*); do
        cp -a $key /data/ssh_host_keys
    done
fi
ssh-keyscan github.com > /data/ssh_host_keys/ssh_known_hosts
for file in $(ls /data/ssh_host_keys/*); do
    cp -a $file /etc/ssh
done

if [ ! -z ${BACKUP_AES_KEY_FILE+x} ] && [ ! -f ${BACKUP_AES_KEY_FILE} ]
then
    openssl rand 214 > "${BACKUP_AES_KEY_FILE}"
fi

if [ -n "$(cat /proc/net/ip_tables_names)" ]; then
    echo "[+] Pre-existing iptables-legacy tables detected. Switching to iptables-legacy."
    update-alternatives --set iptables /usr/sbin/iptables-legacy
    update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
else
    nft list tables > /dev/null 2>&1  # This will load the nf_tables module, if it's not already loaded and is available
    if [ ! -e /sys/module/nf_tables ]; then
        echo '[+] Could not load nf_tables module. Switching to iptables-legacy.'
        update-alternatives --set iptables /usr/sbin/iptables-legacy
        update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
    fi
fi

dojo-node refresh

iptables -F WORKSPACE-NET 2>/dev/null || iptables -N WORKSPACE-NET
iptables -A WORKSPACE-NET -s 10.0.0.0/24 -m conntrack --ctstate NEW -j RETURN
iptables -A WORKSPACE-NET -s 192.168.42.0/24 -m conntrack --ctstate NEW -j RETURN
iptables -A WORKSPACE-NET -s 10.0.0.0/8 -d 10.0.0.3 -m conntrack --ctstate NEW -j ACCEPT
iptables -A WORKSPACE-NET -s 10.0.0.0/8 -d 192.168.42.1 -p tcp --dport 80 -m conntrack --ctstate NEW -j ACCEPT
iptables -A WORKSPACE-NET -s 10.0.0.0/8 -d 192.168.42.1 -p tcp --dport 443 -m conntrack --ctstate NEW -j ACCEPT
iptables -A WORKSPACE-NET -m conntrack --ctstate ESTABLISHED,RELATED -j RETURN
for host in $(cat /opt/pwn.college/user_firewall.allowed); do
    iptables -A WORKSPACE-NET -d $(host $host | awk '/has address/ {print $NF}' | sort | head -n1) -j RETURN
done
iptables -A WORKSPACE-NET -j DROP

iptables -N DOCKER-USER
iptables -A DOCKER-USER -i workspace_net -j WORKSPACE-NET
iptables -A DOCKER-USER -o workspace_net -j WORKSPACE-NET

iptables -A INPUT -i workspace_net -j WORKSPACE-NET
iptables -A OUTPUT -o workspace_net -j WORKSPACE-NET
