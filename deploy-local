#!/bin/bash

function usage {
    echo "Usage: $0 [-w] [-p]"
    echo ""
    echo "  -w  rebuild workspace (removes workspace data to force rebuild)"
    echo "  -p  production mode (sets DOJO_HOST to dojo.dlock.tech)"
    exit
}

REBUILD_WORKSPACE=false
PROD_MODE=false
export DOJO_PATH="./"
export DATA_PATH="./data"

while getopts "wphl" opt; do
    case $opt in
    w)
        REBUILD_WORKSPACE=true
        ;;
    p)
        PROD_MODE=true
        ;;
    l)
        LOCAL=true
        ;;
    h)
        usage
        ;;
    \?)
        echo "Invalid option: -$OPTARG" >&2
        usage
        ;;
    esac
done

if [ "$REBUILD_WORKSPACE" = true ]; then
    echo "Rebuilding workspace"
    sleep 8
    # Build workspace with new dojo
    docker exec dojo bash -c "export DOJO_WORKSPACE=core && dojo compose --profile workspace up workspace-builder --force-recreate"

    # Restart any user containers
    docker exec dojo docker ps -q --filter "name=user_" | xargs -r docker exec dojo docker restart
fi

# check if production mode is set
if [ "$PROD_MODE" = true ]; then
    echo "Running in production mode"
    export DOJO_HOST="dojo.dlock.tech"
    export FRONTEND_HOST="app.dlock.tech"
    export CORS_ORIGINS="https://${FRONTEND_HOST}"
else

    export DOJO_HOST="dojo.localhost"

    if [ "$LOCAL" = true ]; then
        echo "Running in local mode"
        export FRONTEND_HOST="app.dojo.localhost"
        export CORS_ORIGINS="http://${FRONTEND_HOST}"
    else
        export CORS_ORIGINS="http://localhost:3000"
    fi

    # Check if hosts file contains required entries for non-production mode
    if [ "$PROD_MODE" != true ]; then
        MISSING_HOSTS=""
        if ! grep -q "127.0.0.1.*${DOJO_HOST}" /etc/hosts 2>/dev/null; then
            MISSING_HOSTS="${DOJO_HOST}"
        fi
        if [ -n "$FRONTEND_HOST" ] && ! grep -q "127.0.0.1.*${FRONTEND_HOST}" /etc/hosts 2>/dev/null; then
            if [ -n "$MISSING_HOSTS" ]; then
                MISSING_HOSTS="${MISSING_HOSTS} ${FRONTEND_HOST}"
            else
                MISSING_HOSTS="${FRONTEND_HOST}"
            fi
        fi

        if [ -n "$MISSING_HOSTS" ]; then
            echo ""
            echo "⚠️  WARNING: The following hosts are not found in /etc/hosts:"
            echo "   ${MISSING_HOSTS}"
            echo ""
            echo "   Add this line to /etc/hosts for proper local development:"
            echo -n "   127.0.0.1 ${DOJO_HOST}"
            if [ -n "$FRONTEND_HOST" ]; then
                echo -n " ${FRONTEND_HOST}"
            fi
            echo ""
            echo ""
        fi
    fi
fi

docker build -t pwncollege/dojo .
docker stop dojo
docker rm dojo
docker run \
    --name dojo \
    --privileged \
    --device=/dev/kvm:/dev/kvm \
    -v "${DOJO_PATH}:/opt/pwn.college" \
    -v "${DATA_PATH}:/data" \
    -p 23:22 \
    -p 80:80 \
    -p 443:443 \
    -e INTERNET_FOR_ALL=True \
    -e CORS_ORIGINS="${CORS_ORIGINS}" \
    -e DOJO_HOST="${DOJO_HOST}" \
    -e FRONTEND_HOST="${FRONTEND_HOST}" \
    -e LETSENCRYPT_HOST="${DOJO_HOST}" \
    -e VIRTUAL_HOST="${DOJO_HOST}" \
    -e SWAGGER_UI="true" \
    -d \
    pwncollege/dojo
