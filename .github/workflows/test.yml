name: Integration Tests
on:
  pull_request:
  push:
    branches:
      - master
  schedule:
    - cron: '42 06 * * *'
jobs:
  test:
    name: ${{ matrix.mode == 'multinode' && 'Multi-Node' || 'Single-Node' }} Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      matrix:
        mode: [singlenode, multinode]
    steps:
      - name: Host information
        run: |
          echo "::group::Host information"
          echo "Hostname: $(hostname)"
          echo "OS: $(lsb_release -d | cut -f2)"
          echo "Kernel: $(uname -r)"
          echo "Architecture: $(uname -m)"
          echo "IP: $(hostname -I)"
          echo "::endgroup::"
          echo "::group::Filesystem"
          df -h
          echo "::endgroup::"
          echo "::group::Memory"
          free -h
          echo "::endgroup::"
          echo "::group::CPU"
          lscpu
          echo "::endgroup::"

      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Free up disk space
        run: |
          echo "::group::Initial disk usage"
          df -h
          echo "::endgroup::"

          echo "::group::Cleaning up disk space"
          # Remove unnecessary pre-installed software
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo apt-get clean

          # Clean up Docker
          docker system prune -a -f

          echo "::endgroup::"
          echo "::group::Final disk usage"
          df -h
          echo "::endgroup::"

      - name: Make docker cache dir owned by our user
        run: |
          sudo chown $USER:$USER /mnt

      - name: Restore docker and workspace cache
        if: github.event_name != 'schedule'
        uses: actions/cache/restore@v4
        with:
          path: |
            /mnt/dojo-docker
            ${{ matrix.mode == 'multinode' && '/mnt/dojo-docker-node1' || '' }}
            ${{ matrix.mode == 'multinode' && '/mnt/dojo-docker-node2' || '' }}
            /mnt/dojo-workspace
          key: dojo-${{ matrix.mode }}-cache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            dojo-${{ matrix.mode }}-cache-${{ runner.os }}-

      - name: Build docker image
        if: github.event_name != 'schedule'
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: pwncollege/dojo
          load: true
          cache-from: type=gha
      - name: Build and cache docker image
        if: github.event_name == 'schedule'
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: pwncollege/dojo
          load: true
          cache-to: type=gha

      - name: Run ${{ matrix.mode }} dojo tests
        timeout-minutes: 15
        run: |
          echo "Starting ${{ matrix.mode }} integration tests..."
          ./deploy.sh -c dojo-test -g ${{ matrix.mode == 'multinode' && '-M' || '' }} -D /mnt/dojo-docker -W /mnt/dojo-workspace -t

      - name: Output logs
        if: always()
        run: |
          echo "::group::Main node"
          docker exec dojo-test dojo compose logs
          echo "::endgroup::"
          if [ "${{ matrix.mode }}" = "multinode" ]; then
            echo "::group::Workspace node 1"
            docker exec dojo-test-node1 dojo compose logs
            echo "::endgroup::"
            echo "::group::Workspace node 2"
            docker exec dojo-test-node2 dojo compose logs
            echo "::endgroup::"
          fi

      - name: Save docker and workspace cache
        if: github.event_name == 'schedule'
        uses: actions/cache/save@v4
        with:
          path: |
            /mnt/dojo-docker
            ${{ matrix.mode == 'multinode' && '/mnt/dojo-docker-node1' || '' }}
            ${{ matrix.mode == 'multinode' && '/mnt/dojo-docker-node2' || '' }}
            /mnt/dojo-workspace
          key: dojo-${{ matrix.mode }}-cache-${{ runner.os }}-${{ github.run_id }}

      - name: Final filesystem information
        if: always()
        run: |
          echo "::group::Filesystem"
          df -h
          echo "::endgroup::"